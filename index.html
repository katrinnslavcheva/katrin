<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ì–∞–ª–µ—Ä–∏—è –≤—ä—Ä—Ö—É –∫–∞—Ä—Ç–∞</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root{ --card:#fff; --shadow:0 2px 10px rgba(0,0,0,.12); }
    html, body { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    /* –∫–∞—Ä—Ç–∞ –Ω–∞ –ø—ä–ª–µ–Ω –µ–∫—Ä–∞–Ω (—Å–∞–º–æ header –æ—Ç–≥–æ—Ä–µ) */
    #map { position: absolute; inset: 56px 0 0 0; }
    header {
      position: absolute; top: 0; left: 0; right: 0; height: 56px; display: grid;
      grid-template-columns: 1fr auto auto; gap: 8px; align-items: center; padding: 8px 10px;
      background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.85));
      backdrop-filter: blur(6px); z-index: 1000; box-shadow: 0 1px 0 rgba(0,0,0,.06);
    }
    .search { display:flex; align-items:center; gap:8px; background:var(--card);
      border:1px solid #e6e6e6; border-radius:10px; padding:6px 10px; box-shadow:var(--shadow); max-width:620px;}
    input[type="search"]{ border:0; outline:0; width:100%; font-size:14px; background:transparent;}
    .btn { border:1px solid #e6e6e6; background:var(--card); padding:6px 10px; border-radius:10px;
      cursor:pointer; box-shadow:var(--shadow); font-size:13px; }
    .credit { position: absolute; z-index: 999; right: 8px; bottom: 8px; background: #fff;
              padding: 6px 8px; border-radius: 8px; box-shadow: var(--shadow);
              font: 12px system-ui, Arial; }
    .popup img { max-width: 260px; height: auto; display: block; border-radius: 8px;
                 box-shadow: 0 2px 10px rgba(0,0,0,.2); margin-bottom: 6px; }
    .popup h4 { margin: 0 0 4px 0; font: 600 14px/1.3 system-ui, Arial; }
    .popup small { color:#555; }
    .leaflet-control-container .leaflet-top.leaflet-left { margin-top: 64px; }
    @media (max-width: 700px){ header { grid-template-columns: 1fr; height: 96px; } #map { inset: 96px 0 0 0; } }
  </style>
</head>
<body>
  <header>
    <div class="search">
      üîé
      <input id="q" type="search" placeholder="–¢—ä—Ä—Å–∏ –ø–æ –∑–∞–≥–ª–∞–≤–∏–µ –∏–ª–∏ –¥–∞—Ç–∞ (–Ω–∞–ø—Ä. 2025-08)‚Ä¶" />
    </div>
    <button id="fitBtn" class="btn" title="–ü–æ–∫–∞–∂–∏ –≤—Å–∏—á–∫–∏ –º–∞—Ä–∫–µ—Ä–∏">–ü–æ–∫–∞–∂–∏ –≤—Å–∏—á–∫–∏</button>
    <button id="shareBtn" class="btn" title="–ö–æ–ø–∏—Ä–∞–π –ª–∏–Ω–∫ —Å—ä—Å —Å–µ–≥–∞—à–Ω–∏—è –∏–∑–≥–ª–µ–¥">–°–ø–æ–¥–µ–ª–∏ –∏–∑–≥–ª–µ–¥–∞</button>
  </header>

  <div id="map"></div>

  <div class="credit">
    –ö–∞—Ä—Ç–∞: ¬© <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> ¬∑
    –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞: <a href="https://leafletjs.com/" target="_blank">Leaflet</a> ¬∑
    –ö–ª—ä—Å—Ç–µ—Ä–∏: <a href="https://github.com/Leaflet/Leaflet.markercluster" target="_blank">MarkerCluster</a>
  </div>

<script>
/* === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ === */
const IMG_BASE = "./";       // –∞–∫–æ —Å–Ω–∏–º–∫–∏—Ç–µ —Å–∞ –≤ –ø–æ–¥–ø–∞–ø–∫–∞ ‚Äì –Ω–∞–ø—Ä. 'photos/'
const ENABLE_JSON = true;    // –∞–∫–æ –∏–º–∞—à photos.json –¥–æ index.html

/* === –î–∞–Ω–Ω–∏ (fallback) === */
let PHOTOS = [
  { lat: 42.697887755392884, lng: 23.330386398798577, src: "IMG_3380.JPEG", title: "–°–æ—Ñ–∏—è ‚Äì –ù–î–ö", date: "2025-08-21" },
];

/* === UI –µ–ª–µ–º–µ–Ω—Ç–∏ === */
const $q = document.getElementById('q');
const $fitBtn = document.getElementById('fitBtn');
const $shareBtn = document.getElementById('shareBtn');

/* === –ü–æ–º–æ—â–Ω–∏ === */
const normalize = (s) => (s||"").toString().toLowerCase().normalize('NFKD');
const escapeHTML = (str) => (str||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

/* === –ö–ê–†–¢–ê === */
const map = L.map('map', {
  minZoom: 3,
  maxZoom: 19,
  worldCopyJump: true
});

// –¥–æ–±–∞–≤–∏ –ø–ª–æ—á–∫–∏—Ç–µ —Å –º–∞–ª–∫–æ –ø–æ-‚Äûrobust‚Äú –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors',
  crossOrigin: true,
  detectRetina: true,
  keepBuffer: 2
}).addTo(map);

// –∏–∑—á–∞–∫–∞–π –∫–∞—Ä—Ç–∞—Ç–∞ –¥–∞ –µ –≥–æ—Ç–æ–≤–∞ –∏ —Ç–æ–≥–∞–≤–∞ –∑–∞–¥–∞–≤–∞–π –∏–∑–≥–ª–µ–¥–∞
map.whenReady(() => {
  map.setView([54, 15], 4);          // —Ü—è–ª–∞ –ï–≤—Ä–æ–ø–∞
  // –∞–∫–æ –¥—ä—Ä–∂–∏—à –¥–∞ –æ–≥—Ä–∞–Ω–∏—á–∏—à –ø–∞–Ω-–∞ —Å–ª–µ–¥ —Ç–æ–≤–∞:
  // const EUROPE_BOUNDS = L.latLngBounds([34, -25], [72, 45]);
  // map.setMaxBounds(EUROPE_BOUNDS.pad(0.05));
  // map.on('drag', () => map.panInsideBounds(EUROPE_BOUNDS, { animate: false }));
});

// –∞–∫–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ä—Ç –µ –ø—Ä–æ–º–µ–Ω–∏–ª —Ä–∞–∑–º–µ—Ä–∞ —Å–∏ (header, CSS –∏ —Ç.–Ω.)
setTimeout(() => map.invalidateSize(), 0);

/* –°—Ç–∞—Ä—Ç–æ–≤ –∏–∑–≥–ª–µ–¥: ‚Äû—Ü—è–ª–∞ –ï–≤—Ä–æ–ø–∞‚Äú */
const EUROPE_CENTER = [54, 15];        // –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª–Ω–æ –Ω–∞–¥ –¶–µ–Ω—Ç—Ä–∞–ª–Ω–∞ –ï–≤—Ä–æ–ø–∞
const EUROPE_BOUNDS = L.latLngBounds([34, -25], [72, 45]); // SW / NE (–º–∞–ª–∫–æ –ø–æ-—à–∏—Ä–æ–∫–∏ –≥—Ä–∞–Ω–∏—Ü–∏)
map.setView(EUROPE_CENTER, 4);

/* === –ó–µ–ª–µ–Ω –º–∞—Ä–∫–µ—Ä (SVG DivIcon) === */
const greenPin = (function(){
  const svg = encodeURIComponent(`
    <svg width="28" height="42" viewBox="0 0 28 42" xmlns="http://www.w3.org/2000/svg">
      <defs><filter id="s" x="-50%" y="-50%" width="200%" height="200%">
        <feDropShadow dx="0" dy="1.5" stdDeviation="1.5" flood-opacity=".3"/>
      </filter></defs>
      <path filter="url(#s)" d="M14 0C6.82 0 1 5.82 1 13c0 9.31 11.33 23.86 12.01 24.73a1.25 1.25 0 0 0 1.98 0C15.67 36.86 27 22.31 27 13 27 5.82 21.18 0 14 0z" fill="#2ecc71"/>
      <circle cx="14" cy="13" r="5" fill="white" opacity=".85"/>
    </svg>`);
  return L.divIcon({
    className: 'green-pin',
    html: `<img alt="" src="data:image/svg+xml,${svg}" style="display:block;width:28px;height:42px">`,
    iconSize: [28, 42],
    iconAnchor: [14, 42],
    popupAnchor: [0, -36]
  });
})();

/* === –ö–ª—ä—Å—Ç–µ—Ä –≥—Ä—É–ø–∞ === */
const cluster = L.markerClusterGroup();
map.addLayer(cluster);

/* === –°—ä—Å—Ç–æ—è–Ω–∏–µ === */
let items = [];   // { marker, data }

/* === POPUP === */
function popupHTML(p){
  const src = (p.src.startsWith('http') ? p.src : IMG_BASE + p.src);
  return `
    <div class="popup">
      <h4>${escapeHTML(p.title || '–°–Ω–∏–º–∫–∞')}</h4>
      <img loading="lazy" src="${src}" alt="${escapeHTML(p.title || 'Photo')}" />
      ${p.date ? `<small>–î–∞—Ç–∞: ${escapeHTML(p.date)}</small><br/>` : ""}
      <small>–ö–æ–æ—Ä–¥.: ${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}</small>
    </div>`;
}

/* === –ú–∞—Ä–∫–µ—Ä–∏ === */
function buildMarkers(data){
  cluster.clearLayers();
  items = data.map(p => {
    const m = L.marker([p.lat, p.lng], { icon: greenPin }).bindPopup(popupHTML(p), { maxWidth: 280 });
    cluster.addLayer(m);
    return { marker: m, data: p };
  });
  fitAll();
}

/* === Fit –∫—ä–º –≤—Å–∏—á–∫–∏ —Ç–æ—á–∫–∏ (–≤ –ï–≤—Ä–æ–ø–∞) === */
function fitAll(){
  if (!items.length) { map.setView(EUROPE_CENTER, 4); return; }
  const group = L.featureGroup(items.map(x => x.marker));
  const b = group.getBounds();
  map.fitBounds(b.pad(0.2));
}

/* === –§–∏–ª—Ç—ä—Ä –ø–æ –∑–∞–≥–ª–∞–≤–∏–µ/–¥–∞—Ç–∞ === */
function applyFilter(q){
  const qq = normalize(q||'');
  cluster.clearLayers();
  const filtered = qq
    ? items.filter(x => normalize(x.data.title).includes(qq) || normalize(x.data.date).includes(qq))
    : items;
  filtered.forEach(x => cluster.addLayer(x.marker));
}

/* === –°–ø–æ–¥–µ–ª—è–Ω–µ –Ω–∞ –∏–∑–≥–ª–µ–¥–∞ (URL —Å hash) ===
   –§–æ—Ä–º–∞—Ç: #z=4&lat=54&lng=15&q=—Ç–µ–∫—Å—Ç  */
function updateHash(){
  const c = map.getCenter();
  const z = map.getZoom();
  const params = new URLSearchParams();
  params.set('z', z);
  params.set('lat', c.lat.toFixed(5));
  params.set('lng', c.lng.toFixed(5));
  if ($q.value) params.set('q', $q.value);
  location.hash = params.toString();
}
function applyHash(){
  if (!location.hash) return;
  const params = new URLSearchParams(location.hash.slice(1));
  const z = Number(params.get('z'));
  const lat = Number(params.get('lat'));
  const lng = Number(params.get('lng'));
  const q = params.get('q') || '';
  if (!Number.isNaN(z) && !Number.isNaN(lat) && !Number.isNaN(lng)){
    map.setView([lat, lng], z);
  }
  if (q){ $q.value = q; applyFilter(q); }
}

/* === –°—ä–±–∏—Ç–∏—è === */
$q.addEventListener('input', (e) => applyFilter(e.target.value));
$fitBtn.addEventListener('click', fitAll);
$shareBtn.addEventListener('click', async () => {
  updateHash();
  const url = location.href;
  try {
    await navigator.clipboard.writeText(url);
    $shareBtn.textContent = '–õ–∏–Ω–∫ –∫–æ–ø–∏—Ä–∞–Ω!';
    setTimeout(() => $shareBtn.textContent = '–°–ø–æ–¥–µ–ª–∏ –∏–∑–≥–ª–µ–¥–∞', 1200);
  } catch {
    // –∞–∫–æ –Ω—è–º–∞ –¥–æ—Å—Ç—ä–ø –¥–æ clipboard, –ø—Ä–æ—Å—Ç–æ —Å–µ–ª–µ–∫—Ç–∏—Ä–∞–º–µ location bar
    alert('–õ–∏–Ω–∫—ä—Ç –µ –≥–æ—Ç–æ–≤ –≤ –∞–¥—Ä–µ—Å–Ω–∞—Ç–∞ –ª–µ–Ω—Ç–∞.');
  }
});
map.on('moveend zoomend', () => {
  // –æ–±–Ω–æ–≤—è–≤–∞–π hash ‚Äû–º—ä–ª—á–∞–ª–∏–≤–æ‚Äú, –Ω–æ –Ω–µ —Å–ø–∞–º–∏–º –ø—Ä–∏ drag ‚Äì —Å–∞–º–æ –∞–∫–æ –≤–µ—á–µ –∏–º–∞ hash
  if (location.hash) updateHash();
});

/* === –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏ === */
async function loadData(){
  if (!ENABLE_JSON){
    buildMarkers(PHOTOS);
    applyHash();
    return;
  }
  try{
    const res = await fetch('./photos.json', { cache: 'no-store' });
    if (!res.ok) throw new Error('No JSON');
    const json = await res.json();
    if (!Array.isArray(json)) throw new Error('JSON must be an array');
    PHOTOS = json;
  } catch(e){
    console.warn('–ù–µ –µ –Ω–∞–º–µ—Ä–µ–Ω photos.json –∏–ª–∏ –µ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω. –ò–∑–ø–æ–ª–∑–≤–∞–º –≤–≥—Ä–∞–¥–µ–Ω–∏—Ç–µ PHOTOS.', e);
  }
  buildMarkers(PHOTOS);
  applyHash();
}

/* —Å—Ç–∞—Ä—Ç */
loadData();
</script>
</body>
</html>

