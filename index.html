<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–∞—Ä—Ç–∞ —Å –∞–ª–±—É–º–∏ –ø–æ –º–µ—Å—Ç–∞</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root{
      --card:#fff; --shadow:0 2px 10px rgba(0,0,0,.12); --ink:#111; --muted:#666;
      --accent:#2ecc71; --sep:#b6f2cf;
    }
    html, body { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink); }
    #map { position: absolute; inset: 56px 0 0 0; }
    header {
      position: absolute; top:0; left:0; right:0; height:56px; z-index: 1000;
      display:grid; grid-template-columns: 1fr auto auto; gap:8px; align-items:center;
      padding:8px 10px; background:linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.85));
      backdrop-filter: blur(6px); box-shadow: 0 1px 0 rgba(0,0,0,.06);
    }
    .search { display:flex; align-items:center; gap:8px; background:var(--card);
      border:1px solid #e6e6e6; border-radius:10px; padding:6px 10px; box-shadow:var(--shadow); max-width:620px;}
    input[type="search"]{ border:0; outline:0; width:100%; font-size:14px; background:transparent;}
    .btn { border:1px solid #e6e6e6; background:var(--card); padding:6px 10px; border-radius:10px;
      cursor:pointer; box-shadow:var(--shadow); font-size:13px; }
    .credit { position:absolute; right:8px; bottom:8px; z-index:500; background:#fff; padding:6px 8px;
      border-radius:8px; box-shadow:var(--shadow); font:12px system-ui, Arial; }
    .leaflet-control-container .leaflet-top.leaflet-left { margin-top:64px; }

    /* Popup —Å—Ç–∏–ª–æ–≤–µ */
    .leaflet-popup-content-wrapper.photo-popup { padding:0; border-radius:14px; box-shadow:0 6px 24px rgba(0,0,0,.25); }
    .photo-popup .popup { width:300px; padding:12px; }
    .photo-popup .popup h4 { margin:0 0 6px; font:600 15px/1.3 system-ui, Arial; }
    .photo-popup .popup small{ color:#555; }
    .albums { margin-top:8px; display:grid; gap:6px; }
    .album-btn {
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:#f7fff9; border:1px solid #ccf1db; color:#0f5132;
      padding:8px 10px; border-radius:10px; cursor:pointer; font-size:13px;
    }
    .album-btn:hover { background:#eefcf5; }
    .popup .cover {
      width:100%; max-height:220px; object-fit:cover; border-radius:10px; display:block; margin-bottom:8px;
      box-shadow: 0 2px 10px rgba(0,0,0,.12);
    }

    /* –ú–æ–¥–∞–ª–µ–Ω –ø—Ä–æ–∑–æ—Ä–µ—Ü —Å viewer */
    .modal { position: fixed; inset:0; background: rgba(0,0,0,.55); display:none; place-items:center; z-index: 2000; }
    .modal.open { display:grid; }
    .modal-card{
      width:min(1100px, 96vw); max-height: 94vh; overflow:hidden; background:#fff; border-radius:18px; box-shadow:0 10px 40px rgba(0,0,0,.4);
      display:grid; grid-template-rows: auto auto 1fr auto; /* header, meta, viewer, thumbs */
    }
    .modal-head{
      display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #eee;
      position:sticky; top:0; background:#fff; z-index:2;
    }
    .modal-title{ font-weight:700; font-size:18px; }
    .close-btn{ border:0; background:#f2f2f2; padding:8px 12px; border-radius:10px; cursor:pointer; }

    /* –ú–µ—Ç–∞–¥–∞–Ω–Ω–∏ (–ø–µ—Ä–∏–æ–¥ + –æ–ø–∏—Å–∞–Ω–∏–µ) */
    .meta { padding:10px 16px 6px; display:grid; gap:8px; }
    .meta-row { display:grid; grid-template-columns: 170px 1fr; gap:12px; align-items:start; font-size:14px; }
    .meta-label { color:#0f5132; font-weight:600; }
    .sep { height:2px; background: var(--sep); margin:6px 0 4px; border-radius:2px; }

    /* Viewer */
    .viewer {
      position: relative; margin: 8px 16px 12px; border:1px solid #eee; border-radius:14px; overflow:hidden; background:#fafafa;
      display:grid; place-items:center; min-height: 300px;
    }
    .viewer img { max-width:100%; max-height:60vh; object-fit:contain; display:block; background:#fff; }
    .viewer .caption { position:absolute; left:10px; bottom:8px; right:10px; color:#333; font-size:13px;
      background: rgba(255,255,255,.9); padding:6px 10px; border-radius:10px; border:1px solid #eee; }
    .nav-btn {
      position:absolute; top:50%; transform: translateY(-50%); border:0; background:rgba(255,255,255,.9);
      padding:8px 12px; border-radius:12px; cursor:pointer; box-shadow:0 2px 10px rgba(0,0,0,.15);
      font-size:16px;
    }
    .nav-prev { left:8px; }
    .nav-next { right:8px; }

    /* Thumbnails */
    .thumbs {
      padding: 8px 12px 14px; overflow:auto; display:grid; grid-auto-flow: column;
      grid-auto-columns: 120px; gap:10px; background:#fff; border-top:1px solid #eee;
    }
    .thumb { border:2px solid transparent; border-radius:10px; overflow:hidden; cursor:pointer; }
    .thumb img { width:120px; height:90px; object-fit:cover; display:block; }
    .thumb.active { border-color: var(--accent); }

    @media (max-width:700px){
      header{ grid-template-columns:1fr; height:96px; }
      #map{ inset:96px 0 0 0; }
      .meta-row{ grid-template-columns: 1fr; }
      .viewer .caption{ font-size:12px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="search">
      üîé
      <input id="q" type="search" placeholder="–¢—ä—Ä—Å–∏ –º—è—Å—Ç–æ –∏–ª–∏ –∞–ª–±—É–º (–Ω–∞–ø—Ä. 2022) ‚Ä¶" />
    </div>
    <button id="fitBtn" class="btn">–ü–æ–∫–∞–∂–∏ –≤—Å–∏—á–∫–∏</button>
    <button id="shareBtn" class="btn">–°–ø–æ–¥–µ–ª–∏ –∏–∑–≥–ª–µ–¥–∞</button>
  </header>

  <div id="map"></div>

  <div class="credit">
    –ö–∞—Ä—Ç–∞: ¬© <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> ¬∑
    Leaflet ¬∑ MarkerCluster
  </div>

  <!-- –ú–æ–¥–∞–ª –∑–∞ –∞–ª–±—É–º -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <div class="modal-head">
        <div class="modal-title" id="modal-title">–ê–ª–±—É–º</div>
        <button class="close-btn" id="modalClose">–ó–∞—Ç–≤–æ—Ä–∏ ‚úï</button>
      </div>

      <div class="meta">
        <div class="meta-row">
          <div class="meta-label">–ü–µ—Ä–∏–æ–¥ –Ω–∞ –ø–æ—Å–µ—â–µ–Ω–∏–µ</div>
          <div id="metaPeriod"></div>
        </div>
        <div class="sep"></div>
        <div class="meta-row">
          <div class="meta-label">–û–ø–∏—Å–∞–Ω–∏–µ / –∏—Å—Ç–æ—Ä–∏—è</div>
          <div id="metaDesc"></div>
        </div>
      </div>

      <div class="viewer" id="viewer">
        <button class="nav-btn nav-prev" id="navPrev">‚óÄ</button>
        <img id="viewerImg" alt="">
        <div class="caption" id="viewerCaption"></div>
        <button class="nav-btn nav-next" id="navNext">‚ñ∂</button>
      </div>

      <div class="thumbs" id="thumbs"></div>
    </div>
  </div>

<script>
/* ====== –î–ê–ù–ù–ò ======
   –ú—è—Å—Ç–æ -> –∞–ª–±—É–º–∏; –∞–ª–±—É–º = { title, period, description, photos:[{src, caption}] }
*/
const IMG_BASE = "./";

const PLACES = [
  {
    title: "–°–æ—Ñ–∏—è ‚Äì –ù–î–ö",
    lat: 42.697887755392884, lng: 23.330386398798577,
    cover: "IMG_3380.JPEG",
    albums: [
      {
        title: "–ï–∫—Å–∫—É—Ä–∑–∏—è 2021",
        period: "–ê–≤–≥—É—Å—Ç 2021",
        description: "–î–≤—É–¥–Ω–µ–≤–Ω–∞ —Ä–∞–∑—Ö–æ–¥–∫–∞ –∏–∑ —Ü–µ–Ω—Ç—ä—Ä–∞. –ö–æ—Ç–∞–Ω —Å–ø–∞ –ø—Ä–µ–∑ –ø–æ–≤–µ—á–µ—Ç–æ –≤—Ä–µ–º–µ, –Ω–æ –≤—Å–µ –ø–∞–∫ –∏–º–∞–º–µ –≥–µ—Ä–æ–∏—á–Ω–∏ —Å–Ω–∏–º–∫–∏ üêæ.",
        photos: [
          { src: "IMG_3380.JPEG", caption: "–î—Ä–µ–º–µ—â–∏—è—Ç –≥–µ—Ä–æ–π üêæ" },
          // –¥–æ–±–∞–≤–∏ –æ—â–µ —Å–Ω–∏–º–∫–∏ —Ç—É–∫
        ]
      },
      {
        title: "–ï–∫—Å–∫—É—Ä–∑–∏—è 2022",
        period: "–ú–∞–π 2022",
        description: "–í—Ç–æ—Ä–∏ —Ä—É–Ω–¥ ‚Äì –ø–æ–≤–µ—á–µ –ø–∞—Ä–∫–æ–≤–µ, –ø–æ–≤–µ—á–µ —Å–ª–∞–¥–æ–ª–µ–¥, –ø–æ–≤–µ—á–µ —Å–Ω–∏–º–∫–∏.",
        photos: [
          { src: "IMG_3380.JPEG", caption: "–°–ø–æ–º–µ–Ω –æ—Ç 2022" }
        ]
      }
    ]
  }
  // –¥–æ–±–∞–≤—è–π –æ—â–µ –º–µ—Å—Ç–∞...
];

/* ====== –•–ï–õ–ü–ï–†–ò ====== */
const byId = (id)=>document.getElementById(id);
const $q = byId('q'), $fitBtn = byId('fitBtn'), $shareBtn = byId('shareBtn');
const $modal = byId('modal'), $modalClose = byId('modalClose'), $modalTitle = byId('modal-title');
const $metaPeriod = byId('metaPeriod'), $metaDesc = byId('metaDesc');
const $viewer = byId('viewer'), $viewerImg = byId('viewerImg'), $viewerCaption = byId('viewerCaption');
const $navPrev = byId('navPrev'), $navNext = byId('navNext'), $thumbs = byId('thumbs');

const normalize = (s)=> (s||"").toString().toLowerCase().normalize('NFKD');
const esc = (s)=> (s||"").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

/* ====== –ö–ê–†–¢–ê ====== */
const map = L.map('map', { minZoom:3, maxZoom:19, worldCopyJump:true });
const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'&copy; OpenStreetMap contributors', detectRetina:true, keepBuffer:2, maxNativeZoom:19
}).addTo(map);
tiles.on('tileerror', e => console.warn('Tile error:', e.tile?.src));
map.whenReady(()=> map.setView([54, 15], 4));
setTimeout(()=> map.invalidateSize(), 0);
L.control.scale({imperial:false}).addTo(map);

/* –ó–µ–ª–µ–Ω DivIcon */
const greenPin = (()=>{
  const svg = encodeURIComponent(`<svg width="28" height="42" viewBox="0 0 28 42" xmlns="http://www.w3.org/2000/svg">
    <defs><filter id="s" x="-50%" y="-50%" width="200%" height="200%">
      <feDropShadow dx="0" dy="1.5" stdDeviation="1.5" flood-opacity=".3"/></filter></defs>
    <path filter="url(#s)" d="M14 0C6.82 0 1 5.82 1 13c0 9.31 11.33 23.86 12.01 24.73a1.25 1.25 0 0 0 1.98 0C15.67 36.86 27 22.31 27 13 27 5.82 21.18 0 14 0z" fill="#2ecc71"/>
    <circle cx="14" cy="13" r="5" fill="white" opacity=".85"/></svg>`);
  return L.divIcon({ className:'green-pin',
    html:`<img alt="" src="data:image/svg+xml,${svg}" style="display:block;width:28px;height:42px">`,
    iconSize:[28,42], iconAnchor:[14,42], popupAnchor:[0,-36]
  });
})();

const cluster = L.markerClusterGroup().addTo(map);
let items = []; // { marker, place }

/* ====== POPUP HTML ====== */
function popupHTML(place, idx){
  const cover = place.cover ? (place.cover.startsWith('http') ? place.cover : IMG_BASE + place.cover) : null;
  const albums = place.albums || [];
  const albumList = albums.map((a, j)=> `
    <button class="album-btn" data-place="${idx}" data-album="${j}">
      <span>${esc(a.title)}</span>
      <span>–æ—Ç–≤–æ—Ä–∏ ‚Ä∫</span>
    </button>`).join('');
  return `
    <div class="popup">
      <h4>${esc(place.title || '–ú—è—Å—Ç–æ')}</h4>
      ${cover ? `<img class="cover" loading="lazy" src="${cover}" alt="">` : ''}
      <small>–ö–æ–æ—Ä–¥.: ${place.lat.toFixed(5)}, ${place.lng.toFixed(5)}</small>
      <div class="albums" style="margin-top:10px">
        ${albumList || '<small style="color:#999">–ù—è–º–∞ –∞–ª–±—É–º–∏</small>'}
      </div>
    </div>`;
}

/* ====== –ú–ê–†–ö–ï–†–ò ====== */
function buildMarkers(data){
  cluster.clearLayers();
  items = data.map((p, i)=>{
    const m = L.marker([p.lat, p.lng], { icon: greenPin }).bindPopup(
      popupHTML(p, i),
      { className:'photo-popup', maxWidth:320, keepInView:true, autoPanPadding:[20,20] }
    );
    m.on('popupopen', (e)=>{
      const container = e.popup.getElement();
      container.querySelectorAll('.album-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const pi = Number(btn.dataset.place), ai = Number(btn.dataset.album);
          openAlbum(data[pi], data[pi].albums[ai]);
        }, { once:true });
      });
    });
    cluster.addLayer(m);
    return { marker:m, place:p };
  });
  fitAll();
}

/* ====== FIT ALL ====== */
function fitAll(){
  if(!items.length){ map.setView([54,15],4); return; }
  if(items.length===1){ map.setView(items[0].marker.getLatLng(), 12); return; }
  const group = L.featureGroup(items.map(x=>x.marker));
  map.fitBounds(group.getBounds().pad(0.2), { maxZoom:8 });
}

/* ====== –¢–™–†–°–ï–ù–ï ====== */
function applyFilter(q){
  const needle = normalize(q||'');
  cluster.clearLayers();
  const filtered = !needle ? items : items.filter(x=>{
    const t = normalize(x.place.title);
    const hitPlace = t.includes(needle);
    const hitAlbum = (x.place.albums||[]).some(a=> normalize(a.title).includes(needle));
    return hitPlace || hitAlbum;
  });
  filtered.forEach(x=> cluster.addLayer(x.marker));
}

/* ====== –°–ü–û–î–ï–õ–Ø–ù–ï ====== */
function updateHash(){
  const c = map.getCenter(), z = map.getZoom();
  const p = new URLSearchParams();
  p.set('z', z); p.set('lat', c.lat.toFixed(5)); p.set('lng', c.lng.toFixed(5));
  if ($q.value) p.set('q', $q.value);
  location.hash = p.toString();
}
function applyHash(){
  if(!location.hash) return;
  const p = new URLSearchParams(location.hash.slice(1));
  const z = Number(p.get('z')), lat = Number(p.get('lat')), lng = Number(p.get('lng'));
  const q = p.get('q') || '';
  if(!Number.isNaN(z) && !Number.isNaN(lat) && !Number.isNaN(lng)) map.setView([lat,lng], z);
  if(q){ $q.value = q; applyFilter(q); }
}

/* ====== –ú–û–î–ê–õ–ù–ê –ì–ê–õ–ï–†–ò–Ø –° VIEWER ====== */
let currentAlbum = null;
let currentPhotos = [];
let currentIndex = 0;

function openAlbum(place, album){
  currentAlbum = album;
  currentPhotos = album.photos || [];
  currentIndex = 0;

  $modalTitle.textContent = `${place.title} ‚Ä¢ ${album.title}`;
  $metaPeriod.innerHTML = esc(album.period || '‚Äî');
  $metaDesc.innerHTML = esc(album.description || '‚Äî').replace(/\n/g,'<br>');

  renderViewer();
  renderThumbs();

  $modal.classList.add('open');
  $modal.setAttribute('aria-hidden','false');
}

function closeModal(){
  $modal.classList.remove('open');
  $modal.setAttribute('aria-hidden','true');
}

function renderViewer(){
  if(!currentPhotos.length){
    $viewerImg.src = '';
    $viewerCaption.textContent = '–ù—è–º–∞ —Å–Ω–∏–º–∫–∏';
    return;
  }
  const ph = currentPhotos[currentIndex];
  const src = ph.src.startsWith('http') ? ph.src : IMG_BASE + ph.src;
  $viewerImg.src = src;
  $viewerImg.alt = ph.caption || '';
  $viewerCaption.textContent = ph.caption || '';
  // –º–∞—Ä–∫–∏—Ä–∞–π –∞–∫—Ç–∏–≤–Ω–∏—è thumb
  [...$thumbs.children].forEach((el,i)=> el.classList.toggle('active', i===currentIndex));
}

function renderThumbs(){
  $thumbs.innerHTML = currentPhotos.map((ph,i)=>{
    const src = ph.src.startsWith('http') ? ph.src : IMG_BASE + ph.src;
    const cap = esc(ph.caption||'');
    return `<div class="thumb${i===0?' active':''}" data-i="${i}">
      <img loading="lazy" src="${src}" alt="${cap}">
    </div>`;
  }).join('');
  $thumbs.querySelectorAll('.thumb').forEach(el=>{
    el.addEventListener('click', ()=> {
      currentIndex = Number(el.dataset.i);
      renderViewer();
    });
  });
}

function nextPhoto(){ if(!currentPhotos.length) return; currentIndex = (currentIndex+1) % currentPhotos.length; renderViewer(); }
function prevPhoto(){ if(!currentPhotos.length) return; currentIndex = (currentIndex-1+currentPhotos.length) % currentPhotos.length; renderViewer(); }

/* —Å—ä–±–∏—Ç–∏—è –∑–∞ –º–æ–¥–∞–ª–∞ */
$modal.addEventListener('click', (e)=> { if(e.target===$modal) closeModal(); });
$modalClose.addEventListener('click', closeModal);
document.addEventListener('keydown', (e)=> {
  if (!$modal.classList.contains('open')) return;
  if (e.key==='Escape') closeModal();
  if (e.key==='ArrowRight') nextPhoto();
  if (e.key==='ArrowLeft') prevPhoto();
});
byId('navNext').addEventListener('click', nextPhoto);
byId('navPrev').addEventListener('click', prevPhoto);

/* ====== UI —Å—ä–±–∏—Ç–∏—è ====== */
$q.addEventListener('input', (e)=> applyFilter(e.target.value));
$fitBtn.addEventListener('click', fitAll);
$shareBtn.addEventListener('click', async ()=>{
  updateHash();
  const url = location.href;
  try { await navigator.clipboard.writeText(url); $shareBtn.textContent='–õ–∏–Ω–∫ –∫–æ–ø–∏—Ä–∞–Ω!'; setTimeout(()=> $shareBtn.textContent='–°–ø–æ–¥–µ–ª–∏ –∏–∑–≥–ª–µ–¥–∞', 1200); }
  catch { alert('–ö–æ–ø–∏—Ä–∞–π –æ—Ç –∞–¥—Ä–µ—Å–Ω–∞—Ç–∞ –ª–µ–Ω—Ç–∞.'); }
});
map.on('moveend zoomend', ()=> { if(location.hash) updateHash(); });

/* ====== –°–¢–ê–†–¢ ====== */
buildMarkers(PLACES);
applyHash();
</script>
</body>
</html>
